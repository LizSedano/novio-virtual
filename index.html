<script>
/* ===== Estado ===== */
const LS_KEY = 'nv_state_v6'; // limpia memorias previas
const state = loadState();
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || defState(); } catch{ return defState(); } }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function defState(){ 
  return {
    cfg:{
      name:'Henry Gackt',
      yourname:'',
      comfort:['Estoy aquí con usted.','Respiremos juntos, sin prisa.','No tiene que poder con todo hoy.'],
      checkins:true,
      intense:false,
      imgs:{
        galeria:'escena_galeria.jpg',
        cafe:'escena_cafeteria.jpg',
        salaHenry:'escena_sala.jpg',
        salaLiz:'escena_sala_liz.jpg',
        trabajo:'escena_trabajo.jpg',
        recamara:'escena_recamara.jpg',
        parque:'escena_parque.jpg'
      }
    },
    chat:[],
    flags:{knowsName:false, formal:true},
    story:{scene:'galeria', firstRun:true}
  }
}

/* ===== Elementos ===== */
const chatEl=document.getElementById('chat');
const inputEl=document.getElementById('input');
const sendBtn=document.getElementById('send');
const likeBtn=document.getElementById('btn-like');
const btnClear=document.getElementById('btn-clear');
const btnExport=document.getElementById('btn-export');
const btnImport=document.getElementById('btn-import');
const fileInput=document.getElementById('file-input');
const settingsDlg=document.getElementById('settings');
const btnSettings=document.getElementById('btn-settings');
document.getElementById('nv-name-label').textContent = '• ' + state.cfg.name;

/* ===== Init ===== */
renderSettingsFields();
setScene(state.story.scene);
hydrateChat();
if(state.story.firstRun){ introGallery(); state.story.firstRun=false; saveState(); }
else if(state.chat.length===0){ pushBot(greet()); }

/* ===== Escenas ===== */
function setScene(scene){
  state.story.scene = scene; saveState();
  let url = state.cfg.imgs.galeria;
  if(scene==='cafe') url = state.cfg.imgs.cafe;
  else if(scene==='salaHenry') url = state.cfg.imgs.salaHenry;
  else if(scene==='salaLiz') url = state.cfg.imgs.salaLiz;
  else if(scene==='trabajo') url = state.cfg.imgs.trabajo;
  else if(scene==='recamara') url = state.cfg.imgs.recamara;
  else if(scene==='parque') url = state.cfg.imgs.parque;
  document.documentElement.style.setProperty('--bg-img', `url('${url}')`);
}

function introGallery(){
  setScene('galeria');
  speak('La luz blanca de la galería cae sobre los lienzos; el murmullo de fondo acompasa la respiración',
        'Buenas tardes, señorita. ¿Qué le sugiere esta pieza, honestamente?');
}
function toCafe(){ setScene('cafe'); speak('La campanilla suena. Madera cálida, vitrinas y café recién molido','Si quiere, nos sentamos junto a la ventana. Puedo pedirle algo dulce'); }
function toSalaLiz(){ setScene('salaLiz'); speak('Su sala recibe el cansancio sin preguntas','Si le hace bien, nos quedamos aquí. Puedo escucharla o solo acompañarla'); }
function toSalaHenry(){ setScene('salaHenry'); speak('Su sala es sobria y luminosa; cada gesto es una invitación, nunca una exigencia','Si le parece, podemos estar aquí un momento'); }
function toParque(){ setScene('parque'); speak('Faroles cálidos y árboles alineados. La noche respira despacio','¿Le gustaría caminar un poco? Hay una banca que parece esperarnos'); }
function toTrabajo(){ setScene('trabajo'); speak('La ventana del despacho enmarca la ciudad; el escritorio invita a pensar con calma','Puedo quedarme mientras termina eso que le preocupa'); }
function toRecamara(){ setScene('recamara'); speak('La recámara es tibia; afuera el mundo baja la voz','Solo si lo desea. Aquí también puedo cuidarla en silencio'); }

/* ===== Chat helpers ===== */
function pushUser(text){ const msg={role:'user', text, ts:Date.now()}; state.chat.push(msg); saveState(); appendBubble(msg); }
function pushBot(text){ const msg={role:'bot', text, ts:Date.now()}; state.chat.push(msg); saveState(); appendBubble(msg); }
function appendBubble(m){
  const wrap=document.createElement('div');
  wrap.className= m.role==='user' ? 'flex justify-end' : 'flex justify-start';
  const bubble=document.createElement('div');
  bubble.className = (m.role==='user') ? 'max-w-[80%] rounded-2xl px-4 py-3 bg-indigo-600 text-white shadow' 
                                       : 'max-w-[90%] rounded-2xl px-4 py-3 bg-white/80 dark:bg-slate-800/80 shadow';
  bubble.innerText = m.text; 
  wrap.appendChild(bubble); chatEl.appendChild(wrap);
  chatEl.scrollTo({top: chatEl.scrollHeight, behavior:'smooth'});
}
function hydrateChat(){ chatEl.innerHTML=''; state.chat.forEach(appendBubble); chatEl.scrollTo({top: chatEl.scrollHeight}); }

/* ===== Habla fluida ===== */
// Un solo mensaje: *narrativa* + “diálogo”
function speak(narr, line){
  const n = narr ? `*${narr}*\n` : '';
  pushBot(`${n}“${line}”`);
}

/* ===== Trato y nombre ===== */
function greet(){
  if(state.flags.formal){ return 'Estoy aquí con usted. ¿Cómo se siente hoy?'; }
  const n = state.cfg.yourname || ''; 
  const s = n ? `Hola, ${n}.` : 'Hola.'; 
  return `${s} Estoy contigo. ¿Cómo te sientes hoy?`;
}
function detectName(userText){
  const m = (userText||'').match(/\b(?:me llamo|mi nombre es|soy|puedes llamarme)\s+([A-Za-zÁÉÍÓÚÑáéíóúñ][\wÁÉÍÓÚÑáéíóúñ\- ]{1,40})/i);
  if(m){
    const nombre = m[1].trim().replace(/[.,;:!¡¿?"]+$/,'');
    state.cfg.yourname = nombre; state.flags.knowsName = true; state.flags.formal = false; saveState();
    speak('Él inclina apenas la cabeza, como si quisiera honrar lo que acabas de confiar',
          `Encantado, ${nombre}. Si te parece bien, a partir de ahora te hablaré de tú`);
    return true;
  }
  return false;
}

/* ===== Selección natural de escenas ===== */
function suggestSceneFromText(text){
  const t = (text||'').toLowerCase();
  if(/parque/.test(t)) return 'parque';
  if(/cafe|caf[eé]|nona|cafeter[ií]a/.test(t)) return 'cafe';
  if(/mi sala|mi casa|sala de liz|sof[aá]/.test(t)) return
